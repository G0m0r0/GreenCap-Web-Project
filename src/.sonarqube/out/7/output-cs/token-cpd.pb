¸

]D:\Programming\SoftUni-Web-Project\src\Services\GreenCap.Services\Common\ServicesConstants.cs
	namespace 	
GreenCap
 
. 
Services 
{ 
public 

static 
class 
ServicesConstants )
{ 
public 
const 
int 
NumberOfNewsOnPage +
=, -
$num. 0
;0 1
public 
const 
string &
DateTimeHoursStringToLower 6
=7 8
$str9 @
;@ A
public		 
const		 
string		 %
DateTimeHourStringToLower		 5
=		6 7
$str		8 >
;		> ?
public 
const 
string (
DateTimeMinutesStringToLower 8
=9 :
$str; D
;D E
public 
const 
string '
DateTimeMinuteStringToLower 7
=8 9
$str: B
;B C
public 
const 
string -
!ErrorMessageIfArticleDoesNotExist =
=> ?
$str@ T
;T U
public 
const 
string 
DateTimeFormat *
=+ ,
$str- ;
;; <
} 
} º
\D:\Programming\SoftUni-Web-Project\src\Services\GreenCap.Services\IPhysNewsScarperService.cs
	namespace 	
GreenCap
 
. 
Services 
{ 
public 

	interface #
IPhysNewsScarperService ,
{ 
Task 
ImportNewsAsync 
( 
int  
	countNews! *
)* +
;+ ,
} 
}		 Ğ
SD:\Programming\SoftUni-Web-Project\src\Services\GreenCap.Services\Models\NewsDTO.cs
	namespace 	
GreenCap
 
. 
Services 
. 
Models "
{ 
public 

class 
NewsDto 
{ 
public 
string 
Title 
{ 
get !
;! "
set# &
;& '
}( )
public 
string 
ImageUrl 
{  
get! $
;$ %
set& )
;) *
}+ ,
public		 
string		 
Credit		 
{		 
get		 "
;		" #
set		$ '
;		' (
}		) *
public 
string 
MainText 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
NewsShortIntroDTO  

ShortIntro! +
{, -
get. 1
;1 2
set3 6
;6 7
}8 9
} 
} €

]D:\Programming\SoftUni-Web-Project\src\Services\GreenCap.Services\Models\NewsShortIntroDTO.cs
	namespace 	
GreenCap
 
. 
Services 
. 
Models "
{ 
public 

class 
NewsShortIntroDTO "
{ 
public 
string 
Title 
{ 
get !
;! "
set# &
;& '
}( )
public 
string 
MainPageUrl !
{" #
get$ '
;' (
set) ,
;, -
}. /
public		 
string		 
SmallPhotoUrl		 #
{		$ %
get		& )
;		) *
set		+ .
;		. /
}		0 1
public 
string 
Summary 
{ 
get  #
;# $
set% (
;( )
}* +
public 
string 
CategoryName "
{# $
get% (
;( )
set* -
;- .
}/ 0
public 
string 
PostedOn 
{  
get! $
;$ %
set& )
;) *
}+ ,
} 
} Ş“
[D:\Programming\SoftUni-Web-Project\src\Services\GreenCap.Services\PhysNewsScarperService.cs
	namespace 	
GreenCap
 
. 
Services 
{ 
public 

class "
PhysNewsScarperService '
:( )#
IPhysNewsScarperService* A
{ 
private 
const 
string 
BaseUrl $
=% &
$str' i
;i j
private 
readonly 
IConfiguration '
config( .
;. /
private 
readonly 
IBrowsingContext )
context* 1
;1 2
private 
readonly &
IDeletableEntityRepository 3
<3 4
CategoryNews4 @
>@ A

categoryDbB L
;L M
private 
readonly &
IDeletableEntityRepository 3
<3 4
News4 8
>8 9
newsDb: @
;@ A
public "
PhysNewsScarperService %
(% &&
IDeletableEntityRepository &
<& '
CategoryNews' 3
>3 4

categoryDb5 ?
,? @&
IDeletableEntityRepository &
<& '
News' +
>+ ,
newsDb- 3
)3 4
{ 	
this 
. 
config 
= 
Configuration '
.' (
Default( /
./ 0
WithDefaultLoader0 A
(A B
)B C
;C D
this 
. 
context 
= 
BrowsingContext *
.* +
New+ .
(. /
this/ 3
.3 4
config4 :
): ;
;; <
this 
. 

categoryDb 
= 

categoryDb (
;( )
this 
. 
newsDb 
= 
newsDb  
;  !
}   	
public"" 
async"" 
Task"" 
ImportNewsAsync"" )
("") *
int""* -
	countNews"". 7
)""7 8
{## 	
var$$ 
concurrentBagNews$$ !
=$$" #
this$$$ (
.$$( )
ScraperNews$$) 4
($$4 5
	countNews$$5 >
)$$> ?
;$$? @
foreach&& 
(&& 
var&& 
news&& 
in&&  
concurrentBagNews&&! 2
)&&2 3
{'' 
var(( 

categoryId(( 
=((  
await((! &
this((' +
.((+ ,$
GetOrCreateCategoryAsync((, D
(((D E
news((E I
.((I J

ShortIntro((J T
.((T U
CategoryName((U a
)((a b
;((b c
var** 
	newsExist** 
=** 
this**  $
.**$ %
newsDb**% +
.++ 
AllAsNoTracking++ $
(++$ %
)++% &
.,, 
Any,, 
(,, 
x,, 
=>,, 
x,, 
.,,  
Title,,  %
==,,& (
news,,) -
.,,- .
Title,,. 3
),,3 4
;,,4 5
if.. 
(.. 
	newsExist.. 
).. 
{// 
continue00 
;00 
}11 
var33 
newNews33 
=33 
new33 !
News33" &
{44 
Title55 
=55 
news55  
.55  !
Title55! &
,55& '

CategoryId66 
=66  

categoryId66! +
,66+ ,
Credit77 
=77 
news77 !
.77! "
Credit77" (
,77( )
Description88 
=88  !
news88" &
.88& '
MainText88' /
,88/ 0
ImageSmallUrl99 !
=99" #
news99$ (
.99( )

ShortIntro99) 3
.993 4
SmallPhotoUrl994 A
,99A B
ImageUrl:: 
=:: 
news:: #
.::# $
ImageUrl::$ ,
,::, -
OriginalUrl;; 
=;;  !
news;;" &
.;;& '

ShortIntro;;' 1
.;;1 2
MainPageUrl;;2 =
,;;= >
PostedOn<< 
=<< 
news<< #
.<<# $

ShortIntro<<$ .
.<<. /
PostedOn<</ 7
,<<7 8
Summary== 
=== 
news== "
.==" #

ShortIntro==# -
.==- .
Summary==. 5
,==5 6
}>> 
;>> 
await@@ 
this@@ 
.@@ 
newsDb@@ !
.@@! "
AddAsync@@" *
(@@* +
newNews@@+ 2
)@@2 3
;@@3 4
awaitAA 
thisAA 
.AA 
newsDbAA !
.AA! "
SaveChangesAsyncAA" 2
(AA2 3
)AA3 4
;AA4 5
}BB 
}CC 	
privateEE 
asyncEE 
TaskEE 
<EE 
intEE 
>EE $
GetOrCreateCategoryAsyncEE  8
(EE8 9
stringEE9 ?
categoryNameEE@ L
)EEL M
{FF 	
varGG 
categoryGG 
=GG 
thisGG 
.GG  

categoryDbGG  *
.HH 
AllAsNoTrackingHH  
(HH  !
)HH! "
.II 
FirstOrDefaultII 
(II  
xII  !
=>II" $
xII% &
.II& '
NameII' +
==II, .
categoryNameII/ ;
)II; <
;II< =
ifKK 
(KK 
categoryKK 
!=KK 
nullKK  
)KK  !
{LL 
returnMM 
categoryMM 
.MM  
IdMM  "
;MM" #
}NN 
categoryPP 
=PP 
newPP 
CategoryNewsPP '
{QQ 
NameRR 
=RR 
categoryNameRR #
,RR# $
}SS 
;SS 
awaitUU 
thisUU 
.UU 

categoryDbUU !
.UU! "
AddAsyncUU" *
(UU* +
categoryUU+ 3
)UU3 4
;UU4 5
awaitVV 
thisVV 
.VV 

categoryDbVV !
.VV! "
SaveChangesAsyncVV" 2
(VV2 3
)VV3 4
;VV4 5
returnXX 
categoryXX 
.XX 
IdXX 
;XX 
}YY 	
private[[ 
ConcurrentBag[[ 
<[[ 
NewsDto[[ %
>[[% &
ScraperNews[[' 2
([[2 3
int[[3 6
	countNews[[7 @
)[[@ A
{\\ 	
var]] 
concurrentBag]] 
=]] 
new]]  #
ConcurrentBag]]$ 1
<]]1 2
NewsDto]]2 9
>]]9 :
(]]: ;
)]]; <
;]]< =
Parallel`` 
.`` 
For`` 
(`` 
$num`` 
,`` 
	countNews`` %
,``% &
i``' (
=>``) +
{aa 
trybb 
{cc 
vardd 
newsdd 
=dd 
thisdd #
.dd# $
GetNewsdd$ +
(dd+ ,
idd, -
)dd- .
;dd. /
concurrentBagff !
.ff! "
Addff" %
(ff% &
newsff& *
)ff* +
;ff+ ,
}gg 
catchhh 
{ii 
}kk 
}ll 
)ll 
;ll 
returnnn 
concurrentBagnn  
;nn  !
}oo 	
privateqq 
NewsDtoqq 
GetNewsqq 
(qq  
intqq  #
	countNewsqq$ -
)qq- .
{rr 	
intss 
currentPagess 
;ss 
inttt 

newsNumbertt 
;tt 
ifvv 
(vv 
	countNewsvv 
<vv 
ServicesConstantsvv -
.vv- .
NumberOfNewsOnPagevv. @
)vv@ A
{ww 
currentPagexx 
=xx 
$numxx 
;xx  
}yy 
elsezz 
{{{ 
currentPage|| 
=|| 
(|| 
	countNews|| (
/||) *
ServicesConstants||+ <
.||< =
NumberOfNewsOnPage||= O
)||O P
+||Q R
$num||S T
;||T U
}}} 

newsNumber 
= 
	countNews "
%# $
ServicesConstants% 6
.6 7
NumberOfNewsOnPage7 I
;I J
var
 
url
 
=
 
string
 
.
 
Format
 #
(
# $
BaseUrl
$ +
,
+ ,
currentPage
- 8
)
8 9
;
9 :
var
ƒƒ 
document
ƒƒ 
=
ƒƒ 
this
ƒƒ 
.
ƒƒ  
context
ƒƒ  '
.
„„ 
	OpenAsync
„„ 
(
„„ 
url
„„ 
)
„„ 
.
…… 

GetAwaiter
…… 
(
…… 
)
…… 
.
†† 
	GetResult
†† 
(
†† 
)
†† 
;
†† 
if
ŠŠ 
(
ŠŠ 
document
ŠŠ 
.
ŠŠ 

StatusCode
ŠŠ #
==
ŠŠ$ &
HttpStatusCode
ŠŠ' 5
.
ŠŠ5 6
NotFound
ŠŠ6 >
||
ŠŠ? A
document
‹‹ 
.
‹‹ 
DocumentElement
‹‹ (
.
‹‹( )
	OuterHtml
‹‹) 2
.
‹‹2 3
Contains
‹‹3 ;
(
‹‹; <
ServicesConstants
‹‹< M
.
‹‹M N/
!ErrorMessageIfArticleDoesNotExist
‹‹N o
)
‹‹o p
)
‹‹p q
{
ŒŒ 
throw
 
new
 '
InvalidOperationException
 3
(
3 4
)
4 5
;
5 6
}
 
var
 
	shortNews
 
=
 
new
 
NewsShortIntroDTO
  1
(
1 2
)
2 3
;
3 4
var
‘‘ 
mainNews
‘‘ 
=
‘‘ 
new
‘‘ 
NewsDto
‘‘ &
(
‘‘& '
)
‘‘' (
;
‘‘( )
var
““ 
x
““ 
=
““ 
document
““ 
.
““ $
GetElementsByClassName
““ 3
(
““3 4
$str
““4 D
)
““D E
[
““E F

newsNumber
““F P
]
““P Q
;
““Q R
	shortNews
•• 
.
•• 
MainPageUrl
•• !
=
••" #
x
••$ %
.
••% &$
GetElementsByClassName
••& <
(
••< =
$str
••= T
)
••T U
[
••U V
$num
••V W
]
••W X
.
–– "
GetElementsByTagName
–– 1
(
––1 2
$str
––2 5
)
––5 6
[
––6 7
$num
––7 8
]
––8 9
.
—— 
GetAttribute
—— )
(
——) *
$str
——* 0
)
——0 1
;
——1 2
	shortNews
™™ 
.
™™ 
SmallPhotoUrl
™™ #
=
™™$ %
x
™™& '
.
™™' ($
GetElementsByClassName
™™( >
(
™™> ?
$str
™™? V
)
™™V W
[
™™W X
$num
™™X Y
]
™™Y Z
.
šš "
GetElementsByTagName
šš 1
(
šš1 2
$str
šš2 7
)
šš7 8
[
šš8 9
$num
šš9 :
]
šš: ;
.
›› 
GetAttribute
›› )
(
››) *
$str
››* 4
)
››4 5
;
››5 6
	shortNews
 
.
 
Title
 
=
 
x
 
.
  $
GetElementsByClassName
  6
(
6 7
$str
7 O
)
O P
[
P Q
$num
Q R
]
R S
.
 "
GetElementsByTagName
 1
(
1 2
$str
2 5
)
5 6
[
6 7
$num
7 8
]
8 9
.
ŸŸ 
TextContent
ŸŸ (
;
ŸŸ( )
	shortNews
¡¡ 
.
¡¡ 
Summary
¡¡ 
=
¡¡ 
x
¡¡  !
.
¡¡! "$
GetElementsByClassName
¡¡" 8
(
¡¡8 9
$str
¡¡9 Q
)
¡¡Q R
[
¡¡R S
$num
¡¡S T
]
¡¡T U
.
¢¢ "
GetElementsByTagName
¢¢ 0
(
¢¢0 1
$str
¢¢1 4
)
¢¢4 5
[
¢¢5 6
$num
¢¢6 7
]
¢¢7 8
.
££ 
TextContent
££ '
.
¤¤ 
Trim
¤¤  
(
¤¤  !
)
¤¤! "
;
¤¤" #
	shortNews
¦¦ 
.
¦¦ 
CategoryName
¦¦ "
=
¦¦# $
x
¦¦% &
.
¦¦& '$
GetElementsByClassName
¦¦' =
(
¦¦= >
$str
¦¦> M
)
¦¦M N
[
¦¦N O
$num
¦¦O P
]
¦¦P Q
.
§§ "
GetElementsByTagName
§§ 1
(
§§1 2
$str
§§2 5
)
§§5 6
[
§§6 7
$num
§§7 8
]
§§8 9
.
¨¨ 
TextContent
¨¨ (
.
©© 
Trim
©© !
(
©©! "
)
©©" #
;
©©# $
var
«« 
date
«« 
=
«« 
x
«« 
.
«« $
GetElementsByClassName
«« /
(
««/ 0
$str
««0 ?
)
««? @
[
««@ A
$num
««A B
]
««B C
.
¬¬ "
GetElementsByTagName
¬¬ 1
(
¬¬1 2
$str
¬¬2 5
)
¬¬5 6
[
¬¬6 7
$num
¬¬7 8
]
¬¬8 9
.
­­ 
TextContent
­­ (
.
®® 
Trim
®® !
(
®®! "
)
®®" #
;
®®# $
if
°° 
(
°° 
date
°° 
.
°° 
ToLower
°° 
(
°° 
)
°° 
.
°° 
Contains
°° '
(
°°' (
ServicesConstants
°°( 9
.
°°9 :(
DateTimeHoursStringToLower
°°: T
)
°°T U
||
°°V X
date
±± 
.
±± 
ToLower
±± 
(
±± 
)
±± 
.
±± 
Contains
±± '
(
±±' (
ServicesConstants
±±( 9
.
±±9 :*
DateTimeMinutesStringToLower
±±: V
)
±±V W
||
±±X Z
date
²² 
.
²² 
ToLower
²² 
(
²² 
)
²² 
.
²² 
Contains
²² '
(
²²' (
ServicesConstants
²²( 9
.
²²9 :)
DateTimeMinuteStringToLower
²²: U
)
²²U V
||
²²W Y
date
³³ 
.
³³ 
ToLower
³³ 
(
³³ 
)
³³ 
.
³³ 
Contains
³³ '
(
³³' (
ServicesConstants
³³( 9
.
³³9 :)
DateTimeMinuteStringToLower
³³: U
)
³³U V
)
³³V W
{
´´ 
date
µµ 
=
µµ 
DateTime
µµ 
.
µµ  
Now
µµ  #
.
µµ# $
ToString
µµ$ ,
(
µµ, -
ServicesConstants
µµ- >
.
µµ> ?
DateTimeFormat
µµ? M
)
µµM N
;
µµN O
}
¶¶ 
	shortNews
¸¸ 
.
¸¸ 
PostedOn
¸¸ 
=
¸¸  
date
¸¸! %
;
¸¸% &
var
ºº 
mainUrl
ºº 
=
ºº 
	shortNews
ºº #
.
ºº# $
MainPageUrl
ºº$ /
;
ºº/ 0
var
¼¼ 
doc
¼¼ 
=
¼¼ 
this
¼¼ 
.
¼¼ 
context
¼¼ "
.
½½ 
	OpenAsync
½½ 
(
½½ 
mainUrl
½½ "
)
½½" #
.
¾¾ 

GetAwaiter
¾¾ 
(
¾¾ 
)
¾¾ 
.
¿¿ 
	GetResult
¿¿ 
(
¿¿ 
)
¿¿ 
;
¿¿ 
mainNews
ÃÃ 
.
ÃÃ 
Title
ÃÃ 
=
ÃÃ 
doc
ÃÃ  
.
ÃÃ  !$
GetElementsByClassName
ÃÃ! 7
(
ÃÃ7 8
$str
ÃÃ8 F
)
ÃÃF G
[
ÃÃG H
$num
ÃÃH I
]
ÃÃI J
.
ÃÃJ K"
GetElementsByTagName
ÃÃK _
(
ÃÃ_ `
$str
ÃÃ` d
)
ÃÃd e
[
ÃÃe f
$num
ÃÃf g
]
ÃÃg h
.
ÃÃh i
TextContent
ÃÃi t
;
ÃÃt u
mainNews
ÄÄ 
.
ÄÄ 
ImageUrl
ÄÄ 
=
ÄÄ 
doc
ÄÄ  #
.
ÄÄ# $$
GetElementsByClassName
ÄÄ$ :
(
ÄÄ: ;
$str
ÄÄ; H
)
ÄÄH I
[
ÄÄI J
$num
ÄÄJ K
]
ÄÄK L
.
ÄÄL M"
GetElementsByTagName
ÄÄM a
(
ÄÄa b
$str
ÄÄb g
)
ÄÄg h
[
ÄÄh i
$num
ÄÄi j
]
ÄÄj k
.
ÄÄk l
GetAttribute
ÄÄl x
(
ÄÄx y
$str
ÄÄy ~
)
ÄÄ~ 
;ÄÄ €
mainNews
ÅÅ 
.
ÅÅ 
Credit
ÅÅ 
=
ÅÅ 
doc
ÅÅ !
.
ÅÅ! "$
GetElementsByClassName
ÅÅ" 8
(
ÅÅ8 9
$str
ÅÅ9 F
)
ÅÅF G
[
ÅÅG H
$num
ÅÅH I
]
ÅÅI J
.
ÅÅJ K"
GetElementsByTagName
ÅÅK _
(
ÅÅ_ `
$str
ÅÅ` l
)
ÅÅl m
[
ÅÅm n
$num
ÅÅn o
]
ÅÅo p
.
ÅÅp q
TextContent
ÅÅq |
.
ÅÅ| }
TrimÅÅ} 
(ÅÅ ‚
)ÅÅ‚ ƒ
;ÅÅƒ „
var
ÇÇ 
textParagraphs
ÇÇ 
=
ÇÇ  
doc
ÇÇ! $
.
ÇÇ$ %$
GetElementsByClassName
ÇÇ% ;
(
ÇÇ; <
$str
ÇÇ< J
)
ÇÇJ K
[
ÇÇK L
$num
ÇÇL M
]
ÇÇM N
.
ÇÇN O"
GetElementsByTagName
ÇÇO c
(
ÇÇc d
$str
ÇÇd g
)
ÇÇg h
;
ÇÇh i
var
ÈÈ 
sb
ÈÈ 
=
ÈÈ 
new
ÈÈ 
StringBuilder
ÈÈ &
(
ÈÈ& '
)
ÈÈ' (
;
ÈÈ( )
foreach
ÉÉ 
(
ÉÉ 
var
ÉÉ 
	paragraph
ÉÉ "
in
ÉÉ# %
textParagraphs
ÉÉ& 4
)
ÉÉ4 5
{
ÊÊ 
sb
ËË 
.
ËË 

AppendLine
ËË 
(
ËË 
	paragraph
ËË '
.
ËË' (
TextContent
ËË( 3
.
ËË3 4
Trim
ËË4 8
(
ËË8 9
)
ËË9 :
)
ËË: ;
;
ËË; <
sb
ÌÌ 
.
ÌÌ 

AppendLine
ÌÌ 
(
ÌÌ 
)
ÌÌ 
;
ÌÌ  
}
ÍÍ 
mainNews
ÏÏ 
.
ÏÏ 
MainText
ÏÏ 
=
ÏÏ 
sb
ÏÏ  "
.
ÏÏ" #
ToString
ÏÏ# +
(
ÏÏ+ ,
)
ÏÏ, -
.
ÏÏ- .
TrimEnd
ÏÏ. 5
(
ÏÏ5 6
)
ÏÏ6 7
;
ÏÏ7 8
mainNews
ÑÑ 
.
ÑÑ 

ShortIntro
ÑÑ 
=
ÑÑ  !
	shortNews
ÑÑ" +
;
ÑÑ+ ,
return
ÓÓ 
mainNews
ÓÓ 
;
ÓÓ 
}
ÔÔ 	
}
ÕÕ 
}ÖÖ 